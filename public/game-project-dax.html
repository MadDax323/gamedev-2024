<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Roguelike</title>
    <style>
        body {
            font-family: monospace;
            background-color: #000;
            color: #0f0;
            margin: 0;
            padding: 10px;
        }

        #game {
            white-space: pre;
            font-size: 14px;
            overflow: auto;
            max-height: 70vh;
            border: 1px solid #0f0;
            padding: 10px;
        }

        #stats {
            margin-top: 10px;
            border: 1px solid #0f0;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .health-bar {
            background-color: red;
            height: 15px;
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }

        .health-bar .current-health {
            background-color: green;
            height: 100%;
        }

        #message {
            margin-top: 10px;
            color: #ff0;
        }
    </style>
</head>
<body>
    <h1>Enhanced Roguelike</h1>
    <div id="game"></div>
    <div id="stats">
        <div class="health-bar">
            <div id="current-health" class="current-health" style="width: 100%;"></div>
        </div>
        <div id="stat-indicators">
            <div>Health: <span id="health-display">100/100</span></div>
            <div>Armor: <span id="armor-display">0</span></div>
            <div>Damage: <span id="damage-display">10</span></div>
        </div>
    </div>
    <div id="message"></div>

    <script>
        // Constants
        const MAP_WIDTH = 80;
        const MAP_HEIGHT = 40;
        const PLAYER_SYMBOL = '@';
        const WALL_SYMBOL = '#';
        const FLOOR_SYMBOL = '.';
        const CHEST_SYMBOL = 'C';
        const DOOR_SYMBOL = '+';
        const ENEMY_SYMBOL = 'E';
        const FOG_SYMBOL = ' ';
        const FOG_RADIUS = 15;

        // Game state
        let gameMap = [];
        let visibilityMap = [];
        let rooms = [];
        let enemies = [];
        let player = {
            x: 0,
            y: 0,
            health: 100,
            maxHealth: 100,
            armor: 0,
            damage: 10
        };
        let inventory = [];
        let gameMessage = "";

        // Item pool
        const lootTable = [
            { name: "Health Potion", type: "heal", effect: 50 },
            { name: "Steel Sword", type: "weapon", effect: 20 },
            { name: "Iron Armor", type: "armor", effect: 15 },
            { name: "Mana Potion", type: "misc", effect: 30 }
        ];

        class Room {
            constructor(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
            }

            center() {
                return {
                    x: Math.floor(this.x + this.width / 2),
                    y: Math.floor(this.y + this.height / 2)
                };
            }
        }

        function generateMap() {
            gameMap = Array.from({ length: MAP_HEIGHT }, () =>
                Array.from({ length: MAP_WIDTH }, () => WALL_SYMBOL)
            );
            visibilityMap = Array.from({ length: MAP_HEIGHT }, () =>
                Array.from({ length: MAP_WIDTH }, () => false)
            );

            const MAX_ROOMS = 10;
            const MIN_ROOM_SIZE = 6;
            const MAX_ROOM_SIZE = 12;

            for (let i = 0; i < MAX_ROOMS; i++) {
                const width = Math.floor(Math.random() * (MAX_ROOM_SIZE - MIN_ROOM_SIZE + 1)) + MIN_ROOM_SIZE;
                const height = Math.floor(Math.random() * (MAX_ROOM_SIZE - MIN_ROOM_SIZE + 1)) + MIN_ROOM_SIZE;
                const x = Math.floor(Math.random() * (MAP_WIDTH - width - 1)) + 1;
                const y = Math.floor(Math.random() * (MAP_HEIGHT - height - 1)) + 1;

                const newRoom = new Room(x, y, width, height);

                if (!rooms.some(room => intersects(newRoom, room))) {
                    rooms.push(newRoom);
                    fillRoom(newRoom);

                    if (rooms.length > 1) {
                        connectRooms(rooms[rooms.length - 2], newRoom);
                    }
                }
            }

            spawnEntities();
        }

        function fillRoom(room) {
            for (let y = room.y; y < room.y + room.height; y++) {
                for (let x = room.x; x < room.x + room.width; x++) {
                    gameMap[y][x] = FLOOR_SYMBOL;
                }
            }
        }

        function intersects(a, b) {
            return (
                a.x < b.x + b.width &&
                a.x + a.width > b.x &&
                a.y < b.y + b.height &&
                a.y + a.height > b.y
            );
        }

        function connectRooms(a, b) {
            const ax = Math.floor(a.x + a.width / 2);
            const ay = Math.floor(a.y + a.height / 2);
            const bx = Math.floor(b.x + b.width / 2);
            const by = Math.floor(b.y + b.height / 2);

            if (Math.random() < 0.5) {
                createHorizontalTunnel(ax, bx, ay);
                createVerticalTunnel(ay, by, bx);
            } else {
                createVerticalTunnel(ay, by, ax);
                createHorizontalTunnel(ax, bx, by);
            }
        }

        function createHorizontalTunnel(x1, x2, y) {
            for (let x = Math.min(x1, x2); x <= Math.max(x1, x2); x++) {
                gameMap[y][x] = FLOOR_SYMBOL;
            }
        }

        function createVerticalTunnel(y1, y2, x) {
            for (let y = Math.min(y1, y2); y <= Math.max(y1, y2); y++) {
                gameMap[y][x] = FLOOR_SYMBOL;
            }
        }

        function spawnEntities() {
            // Place player in the first room
            const { x, y } = rooms[0].center();
            player.x = x;
            player.y = y;

            // Place enemies and chests in other rooms
            rooms.slice(1).forEach(room => {
                const { x, y } = room.center();

                // Spawn enemy
                const enemyX = x + Math.floor(Math.random() * (room.width - 2)) + 1;
                const enemyY = y + Math.floor(Math.random() * (room.height - 2)) + 1;
                enemies.push({ x: enemyX, y: enemyY, symbol: ENEMY_SYMBOL });

                // Spawn chest
                gameMap[y][x] = CHEST_SYMBOL;
            });
        }

        function drawMap() {
            let output = '';
            for (let y = 0; y < MAP_HEIGHT; y++) {
                for (let x = 0; x < MAP_WIDTH; x++) {
                    if (y === player.y && x === player.x) {
                        output += PLAYER_SYMBOL;
                    } else {
                        output += gameMap[y][x];
                    }
                }
                output += '\n';
            }
            document.getElementById('game').textContent = output;
        }

        function updateStats() {
            document.getElementById('health-display').textContent = `${player.health}/${player.maxHealth}`;
            document.getElementById('armor-display').textContent = player.armor;
            document.getElementById('damage-display').textContent = player.damage;
            const healthBar = document.getElementById('current-health');
            const healthPercentage = (player.health / player.maxHealth) * 100;
            healthBar.style.width = `${healthPercentage}%`;
        }

        // Initialize game
        generateMap();
        drawMap();
        updateStats();
    </script>
</body>
</html>
